spring:
  application:
    name: sellsync-api-server

  # 기본은 local. Render에서는 SPRING_PROFILES_ACTIVE=prod 로 강제
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:local}

  # Tomcat/Multipart
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB

  main:
    allow-circular-references: false

  # ============================================================
  # JPA / Hibernate (공통)
  # ============================================================
  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          time_zone: Asia/Seoul
          batch_size: 100  # 배치 처리 크기
        order_inserts: true  # INSERT 순서 최적화
        order_updates: true  # UPDATE 순서 최적화
        batch_versioned_data: true  # 버전 관리 데이터 배치 처리

  # ============================================================
  # Flyway (공통)
  # ============================================================
  flyway:
    enabled: false
    baseline-on-migrate: true
    locations: classpath:db/migration
    validate-on-migrate: false
    out-of-order: false
    ignore-migration-patterns: "*:missing"

  # ============================================================
  # HikariCP (공통 기본값)
  #  - 실제 풀 크기/타임아웃은 local/prod에서 오버라이드 권장
  # ============================================================
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 30000
      leak-detection-threshold: 180000  # 3분 (대용량 작업 고려)
      data-source-properties:
        cachePrepStmts: true
        prepStmtCacheSize: 250
        prepStmtCacheSqlLimit: 2048
        useServerPrepStmts: true
        useLocalSessionState: true
        rewriteBatchedStatements: true
        cacheResultSetMetadata: true
        cacheServerConfiguration: true
        maintainTimeStats: false

# ============================================================
# Server (공통)
# ============================================================
server:
  port: ${PORT:8080}
  max-http-request-header-size: 256KB
  tomcat:
    max-http-form-post-size: 10MB
    max-http-header-size: 128KB
    max-swallow-size: 10MB
    connection-timeout: 60000

# ============================================================
# Actuator (공통)
# ============================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    tags:
      application: ${spring.application.name}

# ============================================================
# Auth/Security (공통: 값은 환경변수로 주입)
#  - OAuth2 설정은 local/prod 파일로 완전 분리
# ============================================================
jwt:
  secret: ${JWT_SECRET:roDCIFYZmS4ji+ZhwFNJ3S9oEEk4iXRKWUYZ5yMa4wk=}
  access-token-expiration: 3600000
  refresh-token-expiration: 604800000

security:
  encryption:
    key: ${ENCRYPTION_KEY:ruwNCaVxeGCdBqdoVT5YdwqQMudlDBc4wD5LeAG+U1o=}

# ============================================================
# External APIs (공통)
# ============================================================
marketplace:
  smartstore:
    base-url: https://api.commerce.naver.com
    token-url: https://api.commerce.naver.com/external/v1/oauth2/token
    connect-timeout: 5000
    read-timeout: 30000
  coupang:
    base-url: https://api-gateway.coupang.com
    connect-timeout: 5000
    read-timeout: 30000

ecount:
  api:
    base-url: https://oapi.ecount.com
    connect-timeout: 5000
    read-timeout: 30000

# ============================================================
# Scheduler (공통 기본값)
#  - local/prod에서 enabled/cron을 명시적으로 오버라이드
# ============================================================
scheduling:
  order-collection:
    enabled: false
    cron: "0 0 * * * *"

# ============================================================
# App URLs (공통 기본값)
#  - prod에서는 Render/Vercel 도메인으로 반드시 주입
# ============================================================
app:
  frontend-url: ${FRONTEND_URL}
  api-base-url: ${API_BASE_URL}

# ============================================================
# SpringDoc OpenAPI
# ============================================================
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    tags-sorter: alpha
    operations-sorter: method

# ============================================================
# Logging (공통)
# ============================================================
logging:
  level:
    root: INFO
    com.sellsync: INFO
    com.sellsync.api.scheduler: INFO
    org.springframework.web: INFO
    org.hibernate.SQL: INFO
    org.hibernate.type.descriptor.sql.BasicBinder: OFF
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss, Asia/Seoul} [%thread] [%X{traceId:-}] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss, Asia/Seoul} [%thread] [%X{traceId:-}] %-5level %logger{36} - %msg%n"
